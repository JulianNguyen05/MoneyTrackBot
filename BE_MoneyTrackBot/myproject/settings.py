"""
Django settings for myproject.

Generated by 'django-admin startproject' using Django 5.2.7.
"""

import os
import dj_database_url
from pathlib import Path
from datetime import timedelta

# ======================================================================
# üåç C·∫§U H√åNH CHUNG
# ======================================================================

BASE_DIR = Path(__file__).resolve().parent.parent

# Gi·ªØ nguy√™n key nh∆∞ y√™u c·∫ßu
SECRET_KEY = "django-insecure-($p^!x%h3bl5e$!0yma(q-@z9c1ke+1^k&0q@r6%vn4-oe3v4d"

# Gi·ªØ nguy√™n Debug = True
DEBUG = True

ALLOWED_HOSTS = ['*']

CSRF_TRUSTED_ORIGINS = ['https://moneytrackbot.onrender.com']


# ======================================================================
# ‚öôÔ∏è ·ª®NG D·ª§NG
# ======================================================================

INSTALLED_APPS = [
    # Django m·∫∑c ƒë·ªãnh
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",

    # Th∆∞ vi·ªán b√™n th·ª© ba
    "rest_framework",
    "rest_framework_simplejwt",
    "django_filters",

    # ·ª®ng d·ª•ng c·ªßa b·∫°n
    "api.apps.ApiConfig",
]


# ======================================================================
# üß± MIDDLEWARE
# ======================================================================

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "whitenoise.middleware.WhiteNoiseMiddleware", # N√™n d√πng c√°i n√†y tr√™n Render cho nhanh
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]


# ======================================================================
# üöÄ URL & WSGI
# ======================================================================

ROOT_URLCONF = "myproject.urls"
WSGI_APPLICATION = "myproject.wsgi.application"


# ======================================================================
# üé® TEMPLATE
# ======================================================================

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]


# ======================================================================
# üóÑÔ∏è C∆† S·ªû D·ªÆ LI·ªÜU (ƒê√£ c·∫≠p nh·∫≠t logic PostgreSQL)
# ======================================================================

# M·∫∑c ƒë·ªãnh l√† SQLite (cho m√°y t√≠nh)
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}

# üî• N·∫øu ph√°t hi·ªán ƒëang ch·∫°y tr√™n Render (c√≥ DATABASE_URL) -> T·ª± ƒë·ªông chuy·ªÉn sang PostgreSQL
database_url = os.environ.get("DATABASE_URL")
if database_url:
    DATABASES["default"] = dj_database_url.parse(
        database_url,
        conn_max_age=600,
        conn_health_checks=True,
    )


# ======================================================================
# üîí KI·ªÇM TRA M·∫¨T KH·∫®U
# ======================================================================

AUTH_PASSWORD_VALIDATORS = [
    {"NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator"},
    {"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator"},
    {"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator"},
    {"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator"},
]


# ======================================================================
# üïê NG√îN NG·ªÆ & M√öI GI·ªú
# ======================================================================

LANGUAGE_CODE = "vi"
TIME_ZONE = "Asia/Ho_Chi_Minh"
USE_I18N = True
USE_TZ = True


# ======================================================================
# üì¶ FILE Tƒ®NH
# ======================================================================

STATIC_URL = "static/"
STATIC_ROOT = BASE_DIR / "staticfiles"

# S·ª≠ d·ª•ng WhiteNoise (n·∫øu b·∫°n ƒë√£ c√†i trong requirements.txt)
# N·∫øu ch∆∞a c√†i whitenoise th√¨ d√πng d√≤ng d∆∞·ªõi: "django.contrib.staticfiles.storage.StaticFilesStorage"
STATICFILES_STORAGE = "whitenoise.storage.CompressedManifestStaticFilesStorage"


# ======================================================================
# üîë KH√ìA CH√çNH M·∫∂C ƒê·ªäNH
# ======================================================================

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"


# ======================================================================
# üîß DJANGO REST FRAMEWORK
# ======================================================================

REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": (
        "rest_framework_simplejwt.authentication.JWTAuthentication",
    ),
    "DEFAULT_PERMISSION_CLASSES": (
        "rest_framework.permissions.IsAuthenticated",
    ),
    "DEFAULT_FILTER_BACKENDS": (
        "django_filters.rest_framework.DjangoFilterBackend",
        "rest_framework.filters.SearchFilter",
        "rest_framework.filters.OrderingFilter",
    ),
}


# ======================================================================
# üîê JSON WEB TOKEN (JWT)
# ======================================================================

SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(days=1),
    "REFRESH_TOKEN_LIFETIME": timedelta(days=7),
    "ROTATE_REFRESH_TOKENS": True,
    "BLACKLIST_AFTER_ROTATION": True,
    "AUTH_HEADER_TYPES": ("Bearer",),
}


# ======================================================================
# ü§ñ GEMINI API KEY (Gi·ªØ nguy√™n)
# ======================================================================

GEMINI_API_KEY = "AIzaSyBnbrgg4z6gUH6-ALdYivejIF_GHI6Ksqg"